#!/bin/bash

# Default values
CC=gcc

# Parse arguments
for arg in "$@"; do
    case $arg in
        --cc=*)
        CC="${arg#*=}"
        shift
        ;;
        --help)
        echo "Usage: ./configure [--cc=COMPILER]"
        exit 0
        ;;
    esac
done

echo "Checking system for JPEG Encoder Test build..."

# 1. Check Compiler
echo -n "Checking for C compiler ($CC)... "
if command -v "$CC" >/dev/null 2>&1; then
    echo "ok"
else
    echo "not found"
    # Try fallbacks
    for try_cc in clang cc; do
        echo -n "Checking for $try_cc... "
        if command -v "$try_cc" >/dev/null 2>&1; then
            echo "ok"
            CC=$try_cc
            break
        else
            echo "not found"
        fi
    done
    
    if ! command -v "$CC" >/dev/null 2>&1; then
       echo "Error: No suitable C compiler found."
       exit 1
    fi
fi

# 2. Check Source Dependencies
echo -n "Checking for test.c... "
if [ -f "test.c" ]; then echo "ok"; else echo "failed"; exit 1; fi

echo -n "Checking for encoder source... "
if [ -f "../jpeg_encoder.c" ] && [ -f "../jpeg_encoder.h" ]; then
    echo "ok"
else
    echo "failed (../jpeg_encoder.c/h missing)"
    exit 1
fi

# 3. Check Data Dependencies
echo -n "Checking for input data (frame_20260114.bin)... "
if [ -f "frame_20260114.bin" ]; then
    echo "ok"
else
    echo "warning (missing, 'make run' will fail)"
fi

# 4. Generate Configuration
echo "Generating config.mk..."
cat > config.mk <<EOF
# Generated by ./configure
CC=$CC
CFLAGS=-O2 -Wall -I../ -I. -Wno-unused-function
EOF

echo "Configuration complete. Run 'make' to build."
